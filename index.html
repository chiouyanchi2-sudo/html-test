<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iOS Metronome + Cue</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:system-ui}
.wrap{padding:16px;max-width:420px;margin:auto}
button,input{width:100%;font-size:20px;padding:14px;margin:6px 0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.big{font-size:32px;padding:20px}
</style>
</head>

<body>
<div class="wrap">
  <h2>iOS Metronome</h2>

  <button id="unlock">ğŸ”Š å•Ÿç”¨è²éŸ³</button>

  <label>BPM</label>
  <input id="bpm" type="number" value="100" min="40" max="240">

  <div class="row">
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>

  <div class="row">
    <button class="big" onclick="cue('intro')">Intro</button>
    <button class="big" onclick="cue('verse')">Verse</button>
    <button class="big" onclick="cue('chorus')">Chorus</button>
    <button class="big" onclick="cue('bridge')">Bridge</button>
  </div>
</div>

<script>
// ===== Audio core (å·²é©—è­‰ iOS å¯ç”¨) =====
let ctx=null;
let isRunning=false;
let nextTime=0;
let timer=null;
const buffers={};

// ===== Unlock =====
document.getElementById("unlock").onclick = async ()=>{
  if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
  await ctx.resume();

  // wake
  const o=ctx.createOscillator();
  o.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime+0.01);
};

// ===== Click =====
function clickAt(t){
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.frequency.value=1200;
  g.gain.setValueAtTime(0.25,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+0.05);
  o.connect(g);
  g.connect(ctx.destination);
  o.start(t);
  o.stop(t+0.06);
}

// ===== Scheduler =====
function start(){
  if(!ctx) return alert("å…ˆå•Ÿç”¨è²éŸ³");
  isRunning=true;
  nextTime = ctx.currentTime + 0.1;

  timer = setInterval(()=>{
    const bpm = +document.getElementById("bpm").value;
    const spb = 60/bpm;
    while(nextTime < ctx.currentTime + 0.1){
      clickAt(nextTime);
      nextTime += spb;
    }
  },25);
}

function stop(){
  isRunning=false;
  clearInterval(timer);
}

document.getElementById("start").onclick=start;
document.getElementById("stop").onclick=stop;

// ===== Audio buffer =====
async function load(name){
  if(buffers[name]) return buffers[name];
  const r = await fetch(`./audio/${name}.wav`);
  const b = await ctx.decodeAudioData(await r.arrayBuffer());
  buffers[name]=b;
  return b;
}

function play(buf,t){
  const s=ctx.createBufferSource();
  s.buffer=buf;
  s.connect(ctx.destination);
  s.start(t);
}

// ===== Cue =====
let cueToken=0;

async function cue(name){
  if(!isRunning) return;
  cueToken++;
  const my = cueToken;

  const bpm = +document.getElementById("bpm").value;
  const spb = 60/bpm;
  const t0  = nextTime;

  const sec = await load(name);
  const three = await load("three");
  const two   = await load("two");
  const one   = await load("one");

  if(my!==cueToken) return;
  play(sec, t0);

  play(three, t0 + spb);
  play(two,   t0 + 2*spb);
  play(one,   t0 + 3*spb);
}
</script>
</body>
</html>
