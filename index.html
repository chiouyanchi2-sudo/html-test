<!doctype html>
<html>
<body style="background:#111;color:#fff;font-family:sans-serif">

<h2>iOS Metronome Core</h2>

<button id="unlock" style="font-size:20px">UNLOCK AUDIO</button>
<button id="start" style="font-size:20px" disabled>START</button>
<button id="cue"   style="font-size:20px" disabled>PLAY CUE</button>

<script>
let ctx=null;
let bpm=100;
let timer=null;
let nextTime=0;

// === Audio init (same as test.html, proven OK) ===
async function unlock(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
  }
  await ctx.resume();

  // wake sound
  const osc = ctx.createOscillator();
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime+0.01);

  document.getElementById("start").disabled=false;
  document.getElementById("cue").disabled=false;
  console.log("audio unlocked");
}

// === click ===
function clickAt(t){
  const osc = ctx.createOscillator();
  const g   = ctx.createGain();
  osc.frequency.value=1000;
  g.gain.setValueAtTime(0.2,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+0.05);
  osc.connect(g);
  g.connect(ctx.destination);
  osc.start(t);
  osc.stop(t+0.06);
}

// === scheduler ===
function startMetro(){
  nextTime = ctx.currentTime + 0.1;
  timer = setInterval(()=>{
    const spb = 60/bpm;
    while(nextTime < ctx.currentTime + 0.1){
      clickAt(nextTime);
      nextTime += spb;
    }
  },25);
}

// === simple cue (audio file) ===
async function playCue(){
  const res = await fetch("./audio/intro.wav",{cache:"no-store"});
  const arr = await res.arrayBuffer();
  const buf = await ctx.decodeAudioData(arr);

  const src = ctx.createBufferSource();
  src.buffer = buf;
  src.connect(ctx.destination);

  // 播在「下一拍」
  const t = nextTime;
  src.start(t);
}

document.getElementById("unlock").onclick = unlock;
document.getElementById("start").onclick  = startMetro;
document.getElementById("cue").onclick    = playCue;
</script>

</body>
</html>
