<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Metronome 16:9 UI</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e9ecf1;
  font-family:system-ui;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* 16:9 ç•«å¸ƒï¼šæ°¸é ç¶­æŒæ¯”ä¾‹ï¼Œå¡é€²è¢å¹• */
.stage{
  aspect-ratio:16/9;
  width:min(96vw, calc(96vh * 16 / 9));
  height:min(96vh, calc(96vw * 9 / 16));
  background:#111522;
  border:1px solid #2b3146;
  border-radius:18px;
  padding:16px;
  display:grid;
  grid-template-columns: 2fr 1fr; /* å·¦æ§åˆ¶ / å³é¡¯ç¤º */
  gap:16px;
}

/* å·¦å´é¢æ¿ */
.panel{
  background:#171a21;
  border-radius:16px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

h1{margin:0 0 6px;font-size:18px}
label{
  display:block;
  color:#a8b0bf;
  font-size:14px;
  margin-top:6px;
}

/* çµ±ä¸€è¡¨å–®å¤–è§€ */
input,select,button{
  width:100%;
  padding:18px;
  border-radius:16px;
  border:1px solid #2b3146;
  background:#0f121a;
  color:#fff;
  font-size:18px;
  transition: transform .08s, filter .15s, opacity .15s;
}
button.start{background:#2d6cdf;border-color:#2d6cdf;}
button.stop{background:#d64545;border-color:#d64545;}
button.start:disabled,
button.stop:disabled{opacity:.45;filter:grayscale(.3);}

select{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, #a8b0bf 50%),
    linear-gradient(135deg, #a8b0bf 50%, transparent 50%);
  background-position:
    calc(100% - 18px) 50%,
    calc(100% - 12px) 50%;
  background-size:6px 6px, 6px 6px;
  background-repeat:no-repeat;
  padding-right:36px;
}

/* æŒ‰å£“æ„Ÿ + disabled */
button:active{transform:scale(0.98);filter:brightness(0.95)}
button:disabled{opacity:.45;filter:grayscale(.3)}

/* Start/Stop */
button.start,
button.stop{
  font-size:30px;
  padding:70px;
}
button.start.running{filter:brightness(.85)}
button.stop.running{filter:brightness(1.15)}

/* å››æ®µæŒ‰éˆ• 2x2 */
#controls{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-top:6px;
}
.ctrlBtn{
  background:#22283a;
  font-weight:800;
  padding:70px;
  font-size:40px;
}
.ctrlBtn.active{background:#35c759;color:#000;transform:scale(0.97)}

/* å³å´é¡¯ç¤ºå€ */
.display{
  background:#0b0d12;
  border-radius:16px;
  border:1px solid #2b3146;
  display:flex;
  flex-direction:column;
  padding:16px;
  gap:12px;
  justify-content:flex-start;
}

.displayTop{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
}
.displayTitle{
  font-size:18px;
  color:#a8b0bf;
}
.displayHint{
  font-size:14px;
  color:#6f788a;
  text-align:right;
}

/* è¶…å¤§æ‹å­ */
.bigBeat{
  height:400px;          /* å›ºå®šé«˜åº¦ */
  flex:none;             /* ä¸è¦åƒæ•´å€‹ç©ºé–“ */
  font-size:56px;        /* æ˜é¡¯ç¸®å° */
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:16px;
  background:#06070b;
  font-weight:900;
  letter-spacing:2px;
}

/* å°ç¯€/ç‹€æ…‹å¯æ”¾é€™è£¡ï¼ˆä½ ä¹‹å¾Œè¦åŠ ä¹Ÿæ–¹ä¾¿ï¼‰ */
.statusRow{
  display:flex;
  gap:10px;
  color:#a8b0bf;
  font-size:14px;
  justify-content:space-between;
}
.pill{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid #2b3146;
  background:#0f121a;
}
</style>
</head>

<body>
<button onclick="speechWarmup()"
  style="position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:999;padding:12px 18px;border-radius:12px;">
  ğŸ—£ï¸ æ¸¬è©¦è¬›è©±
</button>

<div class="stage">

  <!-- å·¦ï¼šæ§åˆ¶ -->
  <div class="panel">
    <h1>ç¯€æ‹æ§åˆ¶</h1>

    <div>
      <label>BPM</label>
      <input id="bpm" type="number" value="100">
    </div>

    <div>
      <label>æ‹è™Ÿ</label>
      <select id="meter">
        <option value="4">4 / 4</option>
        <option value="3">3 / 4</option>
        <option value="6">6 / 8</option>
      </select>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <button class="start" id="start">Start</button>
      <button class="stop" id="stop" disabled>Stop</button>
    </div>

    <div id="controls">
      <button class="ctrlBtn" id="intro">Intro</button>
      <button class="ctrlBtn" id="verse">Verse</button>
      <button class="ctrlBtn" id="chorus">Chorus</button>
      <button class="ctrlBtn" id="bridge">Bridge</button>
    </div>

    <div class="statusRow" style="margin-top:auto">
      <div class="pill">æ§åˆ¶</div>
    </div>
  </div>

  <!-- å³ï¼šé¡¯ç¤º -->
  <div class="display">
    <div class="displayTop">
      <div class="displayTitle">Beat</div>
    </div>

    <div class="bigBeat" id="beat">â€“</div>

    <div class="statusRow">
    </div>
  </div>

</div>

<script>
function speechWarmup(){
  if(!window.speechSynthesis) return;
  speechSynthesis.cancel();
  speak("Speech ready");
}

// =======================
// Audioï¼ˆæœ€åŸºæœ¬ã€æœ€ç©©ï¼‰
// =======================
let audioCtx = null;
let master = null;

function speak(text){
  if(!window.speechSynthesis) return;
  if(!text) return; // é˜²å‘†ï¼šnull/undefined/ç©ºå­—ä¸²ä¸è¬›

  const u = new SpeechSynthesisUtterance(String(text));
  u.lang = "en-US";

  // iOS æœ‰æ™‚å€™éœ€è¦å…ˆ cancel æ‰æœƒç«‹åˆ»è¬›ä¸‹ä¸€å¥ï¼ˆé¿å…å¡ä½ï¼‰
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

const introBtn  = document.getElementById("intro");
const verseBtn  = document.getElementById("verse");
const chorusBtn = document.getElementById("chorus");
const bridgeBtn = document.getElementById("bridge");
const startBtn = document.getElementById("start");
const stopBtn  = document.getElementById("stop");
startBtn.classList.remove("running");
stopBtn.classList.remove("running");

let armedCue = null;       // ç›®å‰æº–å‚™ä¸­çš„æ®µè½

function initAudio(){
  if(audioCtx) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  audioCtx = new Ctx();
  master = audioCtx.createGain();
  master.gain.value = 1;
  master.connect(audioCtx.destination);
}

function clickSoundAt(accent, time){
  const t = time ?? audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "square";
  osc.frequency.value = accent ? 1400 : 1000;

  gain.gain.setValueAtTime(0.0001, t);
  gain.gain.exponentialRampToValueAtTime(0.25, t + 0.003);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);

  osc.connect(gain);
  gain.connect(master);

  osc.start(t);
  osc.stop(t + 0.06);
}


function setActiveButton(name){
  document.querySelectorAll(".ctrlBtn").forEach(btn=>{
    btn.classList.toggle("active", btn.id === name);
  });
}


// =======================
// ç¯€æ‹ç‹€æ…‹
// =======================
let currentBeat = 0;        // 1..meter
let schedulerTimer = null;
let nextNoteTime = 0;       // AudioContext æ™‚é–“ï¼ˆç§’ï¼‰

const lookaheadMs = 25;     // æ¯ 25ms æª¢æŸ¥ä¸€æ¬¡
const scheduleAheadTime = 0.12; // å…ˆæ’ 120ms å…§çš„äº‹ä»¶
const SPEECH_LEAD_MS = 800; // âœ… èªéŸ³æå‰é‡ï¼ˆä½ è¦è‡ªå·±æ ¡æ­£ï¼Œå…ˆç”¨ 220ï¼‰
let speechEvents = [];      // {timeSec, text}

function scheduleSpeakAt(text, timeSec){
  // ç”¨ setTimeout æŠŠ speak å°åˆ° AudioContext çš„ timeSec
  const delayMs = (timeSec - audioCtx.currentTime) * 1000 - SPEECH_LEAD_MS;
  const ms = Math.max(0, delayMs);
  setTimeout(() => speak(text), ms);
}

function scheduler(){
  const bpm = +document.getElementById("bpm").value || 60;
  const meter = +document.getElementById("meter").value;
  const secPerBeat = 60 / bpm;

  while(nextNoteTime < audioCtx.currentTime + scheduleAheadTime){
    // ä¸‹ä¸€æ‹
    currentBeat = (currentBeat % meter) + 1;
    const isDownbeat = (currentBeat === 1);

    // æ’ clickï¼ˆæº–åˆ°çˆ†ï¼‰
    clickSoundAt(isDownbeat, nextNoteTime);

    // æ’é¡¯ç¤ºï¼ˆç”¨ setTimeout å°é½Šï¼‰
    const beatEl = document.getElementById("beat");
    setTimeout(() => { beatEl.textContent = currentBeat; }, Math.max(0,(nextNoteTime-audioCtx.currentTime)*1000));

    // åˆ°é»è¦å”¸çš„èªéŸ³äº‹ä»¶ï¼šæŠŠåœ¨ scheduleAheadTime å…§çš„éƒ½ä¸Ÿå‡ºå»
    //ï¼ˆspeechEvents æœƒåœ¨æŒ‰æ®µè½æ™‚å¡é€²å»ï¼‰
    for(let i = 0; i < speechEvents.length; i++){
      const ev = speechEvents[i];
      if(ev && ev.timeSec <= nextNoteTime + 0.0001){ // åŒæ‹
        scheduleSpeakAt(ev.text, ev.timeSec);
        speechEvents[i] = null; // æ¨™è¨˜å·²æ’
      }
    }
    // æ¸…æ‰ null
    speechEvents = speechEvents.filter(Boolean);

    nextNoteTime += secPerBeat;
  }

  schedulerTimer = setTimeout(scheduler, lookaheadMs);
}

// =======================
// æ§åˆ¶
// =======================
startBtn.onclick = () => {
  initAudio();
  audioCtx.resume();
  if(window.speechSynthesis) speechSynthesis.cancel();

  currentBeat = 0;
  nextNoteTime = audioCtx.currentTime + 0.05; // ç¨å¾®å¾€å¾Œï¼Œé¿å…å¡ä½
  speechEvents = [];

  startBtn.disabled = true;
  stopBtn.disabled = false;
  startBtn.classList.add("running");
  stopBtn.classList.add("running");

  scheduler();
};

stopBtn.onclick = () => {
  clearTimeout(schedulerTimer);
  schedulerTimer = null;

  currentBeat = 0;
  speechEvents = [];
  document.getElementById("beat").textContent = "â€“";

  startBtn.disabled = false;
  stopBtn.disabled = true;
  startBtn.classList.remove("running");
  stopBtn.classList.remove("running");

  setActiveButton(null);
  if(window.speechSynthesis) speechSynthesis.cancel();
};

function armCue(name, btnId){
  if(window.speechSynthesis) speechSynthesis.cancel();

  // UI
  setActiveButton(btnId);

  // æ‰¾åˆ°ã€Œä¸‹ä¸€å€‹é‡æ‹ã€æœƒç™¼ç”Ÿçš„æ™‚é–“é»
  const bpm = +document.getElementById("bpm").value || 60;
  const meter = +document.getElementById("meter").value;
  const secPerBeat = 60 / bpm;

  // currentBeat æ˜¯ä¸‹ä¸€æ‹è¦è®Šæˆçš„æ‹è™Ÿï¼Œæ‰€ä»¥ã€Œè·é›¢ä¸‹ä¸€å€‹é‡æ‹ã€ï¼š
  const beatsUntilDownbeat = (meter - currentBeat) % meter + 1; // 1..meter
  const downbeatTime = nextNoteTime + (beatsUntilDownbeat - 1) * secPerBeat;

  // ä½ çš„éœ€æ±‚ï¼šé‡æ‹å…ˆå”¸æ®µè½åï¼Œæ¥è‘—ä¸‹ä¸€æ‹ three two one
  speechEvents.push({timeSec: downbeatTime, text: name});
  speechEvents.push({timeSec: downbeatTime + 1*secPerBeat, text: "three"});
  speechEvents.push({timeSec: downbeatTime + 2*secPerBeat, text: "two"});
  speechEvents.push({timeSec: downbeatTime + 3*secPerBeat, text: "one"});

  // å€’æ•¸çµæŸå¾Œç†„ç‡ˆï¼ˆç”¨ setTimeout å°é½Šï¼‰
  setTimeout(() => setActiveButton(null),
    Math.max(0,(downbeatTime + 3*secPerBeat - audioCtx.currentTime)*1000 + 50)
  );
}

introBtn.onclick  = () => armCue("Intro","intro");
verseBtn.onclick  = () => armCue("Verse","verse");
chorusBtn.onclick = () => armCue("Chorus","chorus");
bridgeBtn.onclick = () => armCue("Bridge","bridge");

</script>
</body>
</html>






