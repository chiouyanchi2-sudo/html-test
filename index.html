<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iOS Metronome + Cues (Audio)</title>
<style>
*{box-sizing:border-box}
body{
  margin:0;background:#0f1115;color:#e9ecf1;font-family:system-ui;
  height:100vh;display:flex;align-items:center;justify-content:center;
}
.stage{
  aspect-ratio:16/9;
  width:min(96vw, calc(96vh * 16 / 9));
  height:min(96vh, calc(96vw * 9 / 16));
  background:#111522;border:1px solid #2b3146;border-radius:18px;
  padding:16px;display:grid;grid-template-columns:2fr 1fr;gap:16px;
}
.panel{
  background:#171a21;border-radius:16px;padding:16px;
  display:flex;flex-direction:column;gap:10px;
}
h1{margin:0 0 6px;font-size:18px}
label{display:block;color:#a8b0bf;font-size:14px;margin-top:6px}
input,select,button{
  width:100%;padding:18px;border-radius:16px;border:1px solid #2b3146;
  background:#0f121a;color:#fff;font-size:18px;
  transition:transform .08s, filter .15s, opacity .15s;
}
button:active{transform:scale(.98);filter:brightness(.95)}
button:disabled{opacity:.45;filter:grayscale(.3)}
button.start{background:#2d6cdf;border-color:#2d6cdf;font-size:30px;padding:70px;}
button.stop{background:#d64545;border-color:#d64545;font-size:30px;padding:70px;}
select{
  appearance:none;-webkit-appearance:none;-moz-appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, #a8b0bf 50%),
    linear-gradient(135deg, #a8b0bf 50%, transparent 50%);
  background-position:calc(100% - 18px) 50%,calc(100% - 12px) 50%;
  background-size:6px 6px, 6px 6px;background-repeat:no-repeat;
  padding-right:36px;
}
#controls{
  display:grid;grid-template-columns:repeat(2,1fr);
  gap:10px;margin-top:6px;
}
.ctrlBtn{
  background:#22283a;font-weight:800;padding:70px;font-size:40px;
}
.ctrlBtn.active{background:#35c759;color:#000;transform:scale(0.97)}
.display{
  background:#0b0d12;border-radius:16px;border:1px solid #2b3146;
  display:flex;flex-direction:column;padding:16px;gap:12px;
}
.displayTitle{font-size:18px;color:#a8b0bf}
.bigBeat{
  height:400px;flex:none;font-size:56px;font-weight:900;
  display:flex;align-items:center;justify-content:center;
  border-radius:16px;background:#06070b;letter-spacing:2px;
}
.pill{
  padding:8px 10px;border-radius:999px;border:1px solid #2b3146;
  background:#0f121a;color:#a8b0bf;font-size:14px;
}
.statusRow{display:flex;gap:10px;justify-content:space-between;align-items:center}
#unlockBtn{
  position:fixed;top:12px;left:50%;transform:translateX(-50%);
  z-index:999;padding:12px 18px;border-radius:12px;
  border:1px solid #2b3146;background:#0f121a;color:#fff;
}
</style>
</head>
<body>

<button id="unlockBtn">ğŸ”Š é»ä¸€ä¸‹å•Ÿç”¨è²éŸ³</button>

<div class="stage">
  <div class="panel">
    <h1>ç¯€æ‹æ§åˆ¶</h1>

    <div>
      <label>BPM</label>
      <input id="bpm" type="number" value="100" inputmode="numeric">
    </div>

    <div>
      <label>æ‹è™Ÿ</label>
      <select id="meter">
        <option value="4">4 / 4</option>
        <option value="3">3 / 4</option>
        <option value="6">6 / 8</option>
      </select>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <button class="start" id="start" disabled>Start</button>
      <button class="stop" id="stop" disabled>Stop</button>
    </div>

    <div id="controls">
      <button class="ctrlBtn" id="intro"  disabled>Intro</button>
      <button class="ctrlBtn" id="verse"  disabled>Verse</button>
      <button class="ctrlBtn" id="chorus" disabled>Chorus</button>
      <button class="ctrlBtn" id="bridge" disabled>Bridge</button>
    </div>

    <div class="statusRow" style="margin-top:auto">
      <div class="pill" id="statusPill">å°šæœªè§£é–è²éŸ³</div>
      <div class="pill" id="loadPill">éŸ³æª”ï¼šæœªè¼‰å…¥</div>
    </div>
  </div>

  <div class="display">
    <div class="displayTitle">Beat</div>
    <div class="bigBeat" id="beat">â€“</div>
    <div class="statusRow">
      <div class="pill" id="cuePill">Cueï¼šâ€“</div>
      <div class="pill" id="bpmPill">BPMï¼š100</div>
    </div>
  </div>
</div>

<script>
let audioCtx=null, master=null;
const buffers={};
let audioReady=false, buffersReady=false;

// metronome scheduler
let currentBeat=0;
let nextNoteTime=0;
let schedulerTimer=null;
const lookaheadMs=25;
const scheduleAheadTime=0.12;

// DOM
const unlockBtn=document.getElementById("unlockBtn");
const startBtn=document.getElementById("start");
const stopBtn=document.getElementById("stop");
const beatEl=document.getElementById("beat");
const cuePill=document.getElementById("cuePill");
const bpmPill=document.getElementById("bpmPill");
const statusPill=document.getElementById("statusPill");
const loadPill=document.getElementById("loadPill");

const introBtn=document.getElementById("intro");
const verseBtn=document.getElementById("verse");
const chorusBtn=document.getElementById("chorus");
const bridgeBtn=document.getElementById("bridge");

function initAudio(){
  if(audioCtx) return;
  const Ctx=window.AudioContext||window.webkitAudioContext;
  audioCtx=new Ctx();
  master=audioCtx.createGain();
  master.gain.value=1;
  master.connect(audioCtx.destination);
}

function enableUI(enabled){
  startBtn.disabled=!enabled;
  introBtn.disabled=!enabled;
  verseBtn.disabled=!enabled;
  chorusBtn.disabled=!enabled;
  bridgeBtn.disabled=!enabled;
}

function setActiveButton(id){
  document.querySelectorAll(".ctrlBtn").forEach(btn=>{
    btn.classList.toggle("active", btn.id===id);
  });
}

function clickSoundAt(accent, time){
  const t=time ?? audioCtx.currentTime;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="square";
  osc.frequency.value=accent?1400:1000;
  gain.gain.setValueAtTime(0.0001,t);
  gain.gain.exponentialRampToValueAtTime(0.25,t+0.003);
  gain.gain.exponentialRampToValueAtTime(0.0001,t+0.05);
  osc.connect(gain);
  gain.connect(master);
  osc.start(t);
  osc.stop(t+0.06);
}

async function loadBuffer(name){
  const res=await fetch(`./audio/${name}.wav`, {cache:"no-store"});
  if(!res.ok) throw new Error(`Missing ./audio/${name}.wav`);
  const arr=await res.arrayBuffer();
  buffers[name]=await audioCtx.decodeAudioData(arr);
}

async function loadAllBuffers(){
  loadPill.textContent="éŸ³æª”ï¼šè¼‰å…¥ä¸­â€¦";
  const names=["intro","verse","chorus","bridge","three","two","one"];
  await Promise.all(names.map(loadBuffer));
  buffersReady=true;
  loadPill.textContent="éŸ³æª”ï¼šå·²è¼‰å…¥";
}

function playBufferAt(name, timeSec){
  if(!buffers[name]) return;
  const src=audioCtx.createBufferSource();
  src.buffer=buffers[name];
  src.connect(master);
  src.start(timeSec);
}

function scheduler(){
  const bpm=+document.getElementById("bpm").value || 60;
  const meter=+document.getElementById("meter").value;
  const secPerBeat=60/bpm;
  bpmPill.textContent=`BPMï¼š${bpm}`;

  while(nextNoteTime < audioCtx.currentTime + scheduleAheadTime){
    currentBeat=(currentBeat % meter)+1;
    const isDownbeat=(currentBeat===1);

    clickSoundAt(isDownbeat, nextNoteTime);

    setTimeout(()=>{
      beatEl.textContent=currentBeat;
    }, Math.max(0,(nextNoteTime-audioCtx.currentTime)*1000));

    nextNoteTime += secPerBeat;
  }
  schedulerTimer=setTimeout(scheduler, lookaheadMs);
}

function stopAll(){
  clearTimeout(schedulerTimer);
  schedulerTimer=null;
  currentBeat=0;
  beatEl.textContent="â€“";
  stopBtn.disabled=true;
  startBtn.disabled=false;
  setActiveButton(null);
  cuePill.textContent="Cueï¼šâ€“";
}

async function unlockIOS(){
  initAudio();
  // iOSï¼šä¸€å®šè¦åœ¨ user gesture è£¡ resume
  if(audioCtx.state!=="running"){
    await audioCtx.resume();
  }
  // iOSï¼šæ‰“ä¸€å€‹æ¥µçŸ­ã€å¹¾ä¹ç„¡è²çš„è¼¸å‡ºï¼Œè®“éŸ³è¨Šè·¯å¾‘é†’ä¾†
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  gain.gain.value=0.0001;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+0.01);

  audioReady=true;
  statusPill.textContent="è²éŸ³ï¼šå·²è§£é–";
  unlockBtn.style.display="none";
  enableUI(true);
  startBtn.disabled=false;
  stopBtn.disabled=true;

  // é è¼‰éŸ³æª”ï¼ˆç¬¬ä¸€æ¬¡è¦ç­‰ä¸€ä¸‹ï¼‰
  try{
    await loadAllBuffers();
  }catch(e){
    loadPill.textContent="éŸ³æª”ï¼šç¼ºæª”/è¼‰å…¥å¤±æ•—";
    alert(String(e.message || e));
  }
}

unlockBtn.addEventListener("click", unlockIOS);

startBtn.onclick = () => {
  if(!audioReady){ alert("å…ˆé»ä¸Šæ–¹ã€å•Ÿç”¨è²éŸ³ã€"); return; }
  if(!buffersReady){ alert("éŸ³æª”é‚„æ²’è¼‰å¥½ï¼Œç­‰ä¸€ä¸‹"); return; }

  startBtn.disabled=true;
  stopBtn.disabled=false;

  currentBeat=0;
  nextNoteTime=audioCtx.currentTime + 0.1;
  scheduler();
};

stopBtn.onclick = () => stopAll();

function armCue(name, btnId){
  if(!schedulerTimer){ alert("å…ˆæŒ‰ Start"); return; }
  setActiveButton(btnId);

  const bpm=+document.getElementById("bpm").value || 60;
  const meter=+document.getElementById("meter").value;
  const secPerBeat=60/bpm;

  const beatsUntilDownbeat=(meter - currentBeat) % meter + 1;
  const downbeatTime=nextNoteTime + (beatsUntilDownbeat - 1) * secPerBeat;

  cuePill.textContent=`Cueï¼š${name}`;

  // æ®µè½å + 321ï¼šå…¨éƒ¨èµ° AudioContext â†’ æº–åˆ°æ¯«ç§’
  playBufferAt(name.toLowerCase(), downbeatTime);
  playBufferAt("three", downbeatTime + 1*secPerBeat);
  playBufferAt("two",   downbeatTime + 2*secPerBeat);
  playBufferAt("one",   downbeatTime + 3*secPerBeat);

  setTimeout(()=>{
    setActiveButton(null);
    cuePill.textContent="Cueï¼šâ€“";
  }, Math.max(0,(downbeatTime + 3*secPerBeat - audioCtx.currentTime)*1000 + 80));
}

introBtn.onclick  = () => armCue("Intro","intro");
verseBtn.onclick  = () => armCue("Verse","verse");
chorusBtn.onclick = () => armCue("Chorus","chorus");
bridgeBtn.onclick = () => armCue("Bridge","bridge");

// å°ä¿®ï¼šBPM æ”¹äº†å³ä¸‹ pill ä¹Ÿè·Ÿè‘—æ›´æ–°
document.getElementById("bpm").addEventListener("input", ()=>{
  const bpm=+document.getElementById("bpm").value || 60;
  bpmPill.textContent=`BPMï¼š${bpm}`;
});
</script>
</body>
</html>
